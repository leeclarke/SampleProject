![Key castle Header](img/keycastle.svg)
# File Stream Encryption with Bouncy Castle

Encryption is a funny thing, it's essential to do and do well , but its complicated which is unfortunate since it's so important to get right. When you want to include encryption in your code more often then not you discover that its not very approachable. Ironic isn't it? 

While I can't simplify encryption much, I hope to make it more approachable to accomplish the simple task of encrypting a file using a password by walking you though the process. And as usual, when it comes to code, nothing teaches better then well... ```code```.

## Turning a Password Into a Key 
I'll start off with the [EncryptionUtil]() class. Quick note:  This is written in Groovy but for the most part you can add semicolons and rename to groovy. 


### Create a key from your password
This example is going to use Symmetric encryption to encrypt the file so first step is to converting that easy to remember password into a key for use in encrypting/decrypting the file. 

```
KeyParameter getAesKey(String passphrase){ //Takes your password and returns a key
        byte[] rawKey

        try{
            if(passphrase == null || passphrase.isEmpty()) throw new InvalidParameterException("passphrase is null or empty")

            PBEKeySpec keySpec = new PBEKeySpec(passphrase.toCharArray(), pwdSalt, iterations, keyLength)  // [1]
            SecretKeyFactory keyFactory = SecretKeyFactory.getInstance(KEY_ALGORITHM) [2]
            rawKey = keyFactory.generateSecret(keySpec).getEncoded() [3]
        } catch (Exception e){
            log.error "Key factory init failed with the following error: /n${e.toString()}"
        }

        new KeyParameter(rawKey)
    }

```

The method call ```getAesKey("yourPassword")``` does the job of turning your password into an encryption Key using the PBEKeySpec which stands for Password Based Encryption. There are really on 3 things happening here. [1] Set up the KeySpec using the password and salt. [2] Set up the encryption factory using the specified algorithm "PBEWITHSHA256AND256BITAES-CBC-BC" and [3] Generating the key as a byte array.


### The salt and other spices

Things to note, the pwdSalt  is an array of random generated bytes using the ```SecureRandom``` java object. The key to the salt is that its public and you have to keep it to unencrypt! Typically this can be written unencrypted at the beginning of the file but just for simplicity I have not done so, instead keeping this salt stored as a constant in the sample, in a real implementation you want to write it to the file and generate a new one with every encryption task. (Pleases don't skip this step when implementing this!)

Other things to note are the iterations and key length params being passed in, the iterations is the number of times the password gets hashed and the key length is just specifying how many bits to generate for the password, here I'm using 128bit. 

### The Algo

I'm using "PBEWITHSHA256AND256BITAES-CBC-BC" to create the key and its worth noting what that very long String is all about. It's really just a long concatenated set of Algo specifications.  PBEWITHSHA256 is saying password based encryption using Sha256. Additionally I'm adding 256 AES just to be extra secure and CBC and BC refer to using Block Cypher which means that the encryption is done in distinct blocks. This becomes somewhat relevant when discussing Initialization Vectors which come up later when encrypting the actual file. 

All done! you have taken your "MyS3cr3tPassword" and turned it into something that looks more like this: 